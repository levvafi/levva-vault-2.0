// SPDX-License-Identifier: MIT
pragma solidity ^0.8.28;

import {Test} from "lib/forge-std/src/Test.sol";
import {Vm} from "lib/forge-std/src/Vm.sol";
import {console} from "lib/forge-std/src/console.sol";
import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import {ERC20} from "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import {PendleAdapter} from "../../../contracts/adapters/pendle/PendleAdapter.sol";
import {
    TokenInput,
    ApproxParams,
    LimitOrderData,
    SwapData,
    SwapType,
    TokenOutput
} from "@pendle/core-v2/interfaces/IPAllActionTypeV3.sol";

import {IPSwapAggregator, SwapDataExtra} from "@pendle/core-v2/router/swap-aggregator/IPSwapAggregator.sol";
import {PendleAdapterTestBase} from "./PendleAdapterTestBase.t.sol";

contract PendleAdapter_SwapTokenToToken is PendleAdapterTestBase {
    uint256 constant FORK_BLOCK_NUMBER = 22531700;

    address internal constant WETH = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
    address internal constant USDe = 0x4c9EDD5852cd905f086C759E8383e09bff1E68B3;
    address internal constant tETH = 0xD11c452fc99cF405034ee446803b6F6c1F6d5ED8;

    function setUp() public override {
        super.setUp();
        vm.rollFork(FORK_BLOCK_NUMBER);

        oracle.setPrice(oracle.ONE(), WETH, address(USDC));
        oracle.setPrice(oracle.ONE(), USDe, address(USDC));
        oracle.setPrice(oracle.ONE(), tETH, address(USDC));

        vault.addTrackedAsset(WETH);
        vault.addTrackedAsset(USDe);
        vault.addTrackedAsset(tETH);
    }

    function test_swap_USDC_to_USDe() public {
        IPSwapAggregator pendleSwap = IPSwapAggregator(0xd4e9B0d466789d7F6201442eecCBA6a75A552db0);
        SwapData memory swap = SwapData({
            swapType: SwapType(1),
            extRouter: 0x6131B5fae19EA4f9D964eAc0408E4408b66337b5,
            extCalldata: hex"e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000005a000000000000000000000000000000000000000000000000000000000000007e000000000000000000000000000000000000000000000000000000000000004e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000004c9edd5852cd905f086c759e8383e09bff1e68b3000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000007fffffff0000000000000000000000000000000000000000000000000000000000000480000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000408bf36a3b0000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000004444c5dc75cb358380d2e3de08a900000000000000000000000000000000000000000000000000000000005f5e100000000000000000000000000000000000022d473030f116ddee9f6b43ac78ba3000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000004c9edd5852cd905f086c759e8383e09bff1e68b3000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010000000000000000000000004440854b2d02c57a0dc5c58b7a884562d875c0c400000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000010d33b018c0e8ab4f3fb0000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000007270e0000000000000000000000000000000000000000e89bf8eefffc1befcaa8b037eb0000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000682dde0b00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000413c101c866f1b28b65a5de997603f0f608a438ffddfe8658c445a6a748e8033da2d0997ec6bcf183c0e775e535ab1888c580ba336cc99c8d81f11703d5168e2601b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000005adced3d5bfe00000000000000056a7592fd84f7cf00000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000004c9edd5852cd905f086c759e8383e09bff1e68b3000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f9460000000000000000000000000000000000000000000000000000000005f5e100000000000000000000000000000000000000000000000004dfd0377dc478a0b30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000005f5e10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002847b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a2239392e36393739303631333733353336222c22416d6f756e744f7574555344223a2239392e3734343636373035323739363333222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a223939393034393139353236333938343830313238222c2254696d657374616d70223a313734373833363234372c22526f7574654944223a2238643332633038312d353434632d343639662d393662392d3838633732303966303961663a62393533663630392d613564662d346161622d623638352d633835303932353530353963222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a224a78616a5538694d45544f45544946306d54425859564f47695369333039546b492f5058625953674257526b75736d7577714f59534e763231676c4e4c6f64356b736e4d7847345354476c7252786e6e643461387976676a6f447567493653345878345572686e714c73504a594b54574c494c414c4c684843394d2b4866313871482b68344f3750715137766b697464495a6f4c74637142524742484e61383033676e71786735502f6a326668364a35704c34596e2b517a68444a584262694b43724d4d2b62744a4e30636433736b6747454e4948587654364c784b642f3875397a486c56414558654d504849346930486c6372656364386c736577465a78326b5554575a4b3274636a65764d7051665769507463516f44366c6e514e53563176684e376a43663962556a4e615051444b385a5473477669344a443171685641697553537865726f3043664375466d646359417463673d3d227d7d00000000000000000000000000000000000000000000000000000000",
            needScale: false
        });

        SwapDataExtra memory swapDataExtra =
            SwapDataExtra({tokenIn: address(USDC), tokenOut: USDe, minOut: 80e6, swapData: swap});
        uint256 netIn = 100e6;

        _swapTokenToToken(pendleSwap, swapDataExtra, netIn);
    }

    function test_swap_USDC_to_tETH() public {
        IPSwapAggregator pendleSwap = IPSwapAggregator(0xd4e9B0d466789d7F6201442eecCBA6a75A552db0);
        SwapData memory swap = SwapData({
            swapType: SwapType(4),
            extRouter: 0x6088d94C5a40CEcd3ae2D4e0710cA687b91c61d0,
            extCalldata: hex"03b87e5f000000000000000000000000000000000000000000000000000000000001a663000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed80000000000000000000000000000000000000000000000000000000005f5e1000000000000000000000000000000000000000000000000000067514dee8d27b800000000000000000000000000000000000000000000000000000000682dfd200000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000009a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000005f5e100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000056000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000000100000000000000000000000003f911aedc25c770e701b8f563e8102cfacd62c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000003f911aedc25c770e701b8f563e8102cfacd62c00000000000000000000000000000000000000000000000000000000000000001000000000000000000002710763d3b7296e7c9718ad5b058ac2692a19e5b36380000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000bb800000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000010000000000000000000000004347b972898b2fd780adbdaa29b4a5160a9f4fe500000000000000000000000000000000000000000000000000000000000000010000000000000000000000004347b972898b2fd780adbdaa29b4a5160a9f4fe50000000000000000000000000000000000000000000000000000000000000001000000000000000000002710202a6012894ae5c288ea824cbc8a9bfb26a49b930000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000cd5fe23c85820f7b72d0926fc9b05b43e359b7ee000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000cd5fe23c85820f7b72d0926fc9b05b43e359b7ee0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000ecd7eef15713997528896cb5db7ec316db4c21010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000ecd7eef15713997528896cb5db7ec316db4c21010000000000000000000000000000000000000000000000000000000000000001000000000000000000002710394a1e1b934cb4f4a0dc17bdd592ec078741542f0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000cd5fe23c85820f7b72d0926fc9b05b43e359b7ee000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed80000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            needScale: false
        });

        SwapDataExtra memory swapDataExtra =
            SwapDataExtra({tokenIn: address(USDC), tokenOut: tETH, minOut: 80e6, swapData: swap});
        uint256 netIn = 100e6;

        _swapTokenToToken(pendleSwap, swapDataExtra, netIn);
    }
}
