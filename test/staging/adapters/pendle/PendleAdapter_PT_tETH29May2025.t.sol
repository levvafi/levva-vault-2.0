// SPDX-License-Identifier: MIT
pragma solidity ^0.8.28;

import {Test} from "lib/forge-std/src/Test.sol";
import {Vm} from "lib/forge-std/src/Vm.sol";
import {console} from "lib/forge-std/src/console.sol";
import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import {ERC20} from "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import {PendleAdapter} from "../../../../contracts/adapters/pendle/PendleAdapter.sol";
import {
    TokenInput,
    ApproxParams,
    LimitOrderData,
    SwapData,
    SwapType,
    TokenOutput
} from "@pendle/core-v2/contracts/interfaces/IPAllActionTypeV3.sol";
import {PendleAdapterTestBase} from "./PendleAdapterTestBase.t.sol";

contract PendleAdapterTest is PendleAdapterTestBase {
    address internal constant PENDLE_MARKET = 0xBDb8F9729d3194f75fD1A3D9bc4FFe0DDe3A404c; //PT_tETH_29May2025Market
    address internal constant PT_TOKEN = 0x84D17Ef6BeC165484c320B852eEB294203e191be; //PT_tETH_29May2025

    function setUp() public override {
        super.setUp();
        vm.rollFork(22_480_700);
    }

    function test_swap_wstETHToken_to_pt() public {
        address wstETHToken = 0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0;
        uint256 amountIn = 10 * 10 ** 18;

        TokenInput memory tokenInput = _createTokenInputSimple(wstETHToken, amountIn);

        _swapTokenToPt(PENDLE_MARKET, _createDefaultApproxParams(), tokenInput, PT_TOKEN);
    }

    function test_swap_tETH_to_pt() public {
        address tETHToken = 0xD11c452fc99cF405034ee446803b6F6c1F6d5ED8;
        uint256 amountIn = 10 * 10 ** 18;

        TokenInput memory tokenInput = _createTokenInputSimple(tETHToken, amountIn);

        _swapTokenToPt(PENDLE_MARKET, _createDefaultApproxParams(), tokenInput, PT_TOKEN);
    }

    function test_swap_Usdc_to_Pt() public {
        address usdcToken = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;

        /*
        To get call data use curl below

        curl -X 'GET' \
    'https://api-v2.pendle.finance/core/v1/sdk/1/markets/0xBDb8F9729d3194f75fD1A3D9bc4FFe0DDe3A404c/swap?\
    receiver=0x20bC1b12B486AF80D3B5dc0A2DE6D2CD69Af9bBE&
    slippage=0.1&enableAggregator=true&
    tokenIn=0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48&
    tokenOut=0x84D17Ef6BeC165484c320B852eEB294203e191be&
    amountIn=100000000' \
    -H 'accept: application/json'
        */

        SwapData memory swapData = SwapData({
            swapType: SwapType(4),
            extRouter: 0x156ACd2bc5fC336D59BAAE602a2BD9b5e20D6672,
            extCalldata: hex"03b87e5f000000000000000000000000000000000000000000000000000000000001a663000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed80000000000000000000000000000000000000000000000000000000005f5e10000000000000000000000000000000000000000000000000000669708f9df0db20000000000000000000000000000000000000000000000000000000068247c460000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000009a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000005f5e100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000056000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000000010000000000000000000000004347b972898b2fd780adbdaa29b4a5160a9f4fe500000000000000000000000000000000000000000000000000000000000000010000000000000000000000004347b972898b2fd780adbdaa29b4a5160a9f4fe50000000000000000000000000000000000000000000000000000000000000001000000000000000000002710e0554a476a092703abdb3ef35c80e0d76d32939f0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000010000000000000000000000004347b972898b2fd780adbdaa29b4a5160a9f4fe500000000000000000000000000000000000000000000000000000000000000010000000000000000000000004347b972898b2fd780adbdaa29b4a5160a9f4fe50000000000000000000000000000000000000000000000000000000000000001000000000000000000002710202a6012894ae5c288ea824cbc8a9bfb26a49b930000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000cd5fe23c85820f7b72d0926fc9b05b43e359b7ee000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000cd5fe23c85820f7b72d0926fc9b05b43e359b7ee0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000ecd7eef15713997528896cb5db7ec316db4c21010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000ecd7eef15713997528896cb5db7ec316db4c21010000000000000000000000000000000000000000000000000000000000000001000000000000000000002710a3602ec7d5f17e5cd3071dda8f9b5b3d5dc275a30000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000cd5fe23c85820f7b72d0926fc9b05b43e359b7ee000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed80000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            needScale: false
        });

        TokenInput memory usdcTokenInput = TokenInput({
            tokenIn: usdcToken,
            netTokenIn: 100e6,
            tokenMintSy: 0xD11c452fc99cF405034ee446803b6F6c1F6d5ED8,
            pendleSwap: 0x313e7Ef7d52f5C10aC04ebaa4d33CDc68634c212,
            swapData: swapData
        });

        _swapTokenToPt(PENDLE_MARKET, _createDefaultApproxParams(), usdcTokenInput, PT_TOKEN);
    }

    function test_swap_Pt_to_USDC() public {
        address usdcToken = 0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48;
        uint256 amountIn = 15e17; // 1.5 PT

        /*
         To get call data use curl below
         curl -X 'GET' \
    'https://api-v2.pendle.finance/core/v1/sdk/1/markets/0xBDb8F9729d3194f75fD1A3D9bc4FFe0DDe3A404c/swap?receiver=0xBDb8F9729d3194f75fD1A3D9bc4FFe0DDe3A404c&slippage=0.05&enableAggregator=true&tokenIn=0x84D17Ef6BeC165484c320B852eEB294203e191be&tokenOut=0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48&amountIn=1500000000000000000' \
    -H 'accept: application/json'
         */

        SwapData memory swapData = SwapData({
            swapType: SwapType(1),
            extRouter: 0x6131B5fae19EA4f9D964eAc0408E4408b66337b5,
            extCalldata: hex"e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000068000000000000000000000000000000000000000000000000000000000000008c000000000000000000000000000000000000000000000000000000000000005c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed8000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000007fffffff0000000000000000000000000000000000000000000000000000000000000560000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000040d90ce491000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000100000000000000000000000000394a1e1b934cb4f4a0dc17bdd592ec078741542f000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed8000000000000000000000000cd5fe23c85820f7b72d0926fc9b05b43e359b7ee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000001190dbf0aa58e7c100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000202a6012894ae5c288ea824cbc8a9bfb26a49b93000000000000000000000000cd5fe23c85820f7b72d0926fc9b05b43e359b7ee000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000013cfd0475164b88b000000000000000000000000fffd8963efd1fc6a506488495d951d5263988d250000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000e0554a476a092703abdb3ef35c80e0d76d32939f000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000001524bb76392cf1c1000000000000000000000000fffd8963efd1fc6a506488495d951d5263988d250000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000f7c000000000000000000000000ec54618e000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed8000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f9460000000000000000000000000000000000000000000000001190dbf0aa58e7c100000000000000000000000000000000000000000000000000000000d4b257cc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000001190dbf0aa58e7c1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000027b7b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a223938362e31363231313630313236343339222c22416d6f756e744f7574555344223a22333936372e313630323539373034383037222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2233393634393532393734222c2254696d657374616d70223a313734373231393234332c22526f7574654944223a2262343238363063312d666438632d343166392d393432362d6166633961333833313133323a36383234393637342d336337372d343261352d623561632d393638383233616633326238222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2254727a59727254673734786f456d35424a6a2f6b644a47336e7367575a4462394a434b6e7252574f6e444f4d6457416b356c2f365272475533536653774a65672b4b7637714e4e5749797774302b763067797044386d6f5a7a662b3852704249614a79324a4342524e5a614c61524d6777456b733871436b466d6e3431717877434e755735776354664b70564566576d39594e5061474f4d32396c484937756a6d62394337514e31355330504c6662497177582f39507230646d4c2f615a35414848336a65766658356f5635674a756d426f2f42433852795259542b492f5a446d6d64496e59634c54584843354367357a4166316679717175534371465a334f34567234754f704943714d2f374745676f54686a333755665231722b337a765542714a31594b4b643555536549697835373536316a3562473651656f62572b6266426163635353526438596c4c473032323345744c773d3d227d7d0000000000",
            needScale: true
        });

        TokenOutput memory tokenOutput = TokenOutput({
            tokenOut: usdcToken,
            minTokenOut: 3700917437,
            tokenRedeemSy: 0xD11c452fc99cF405034ee446803b6F6c1F6d5ED8,
            pendleSwap: 0xd4e9B0d466789d7F6201442eecCBA6a75A552db0,
            swapData: swapData
        });

        _swapPtToToken(PENDLE_MARKET, PT_TOKEN, amountIn, tokenOutput);
    }

    function test_swap_WETH_to_Pt() public {
        address wethToken = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
        uint256 amountIn = 5e18;

        /*
         To get call data use curl below
         curl -X 'GET' \
    'https://api-v2.pendle.finance/core/v1/sdk/1/markets/0xBDb8F9729d3194f75fD1A3D9bc4FFe0DDe3A404c/swap?receiver=0xBDb8F9729d3194f75fD1A3D9bc4FFe0DDe3A404c&slippage=0.05&enableAggregator=true&tokenIn=0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2&tokenOut=0x84D17Ef6BeC165484c320B852eEB294203e191be&amountIn=5000000000000000000' \
    -H 'accept: application/json'
        */

        SwapData memory swapData = SwapData({
            swapType: SwapType(1),
            extRouter: 0x6131B5fae19EA4f9D964eAc0408E4408b66337b5,
            extCalldata: hex"e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000008e00000000000000000000000000000000000000000000000000000000000000b200000000000000000000000000000000000000000000000000000000000000820000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed8000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000007fffffff00000000000000000000000000000000000000000000000000000000000007c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000000401cb1871c0000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000136f1efcc3f8f88516b9e94110d56fdbfb1778d100000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000022d473030f116ddee9f6b43ac78ba300000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000004563918244f40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000fe906e030a44ef24ca8c7dc7b7c53a6c4f00ce90000000000000000000000000fe906e030a44ef24ca8c7dc7b7c53a6c4f00ce90000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c4ce391d82d164c166df9c8336ddf84206b2f812000000000000000000000000775f661b0bd1739349b9a2a3ef60be277c5d2d290000000000000000000000000000000000000000000000000000000000000000000000000000000000000000775f661b0bd1739349b9a2a3ef60be277c5d2d290000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000401cb1871c0000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000136f1efcc3f8f88516b9e94110d56fdbfb1778d100000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000022d473030f116ddee9f6b43ac78ba300000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000007f39c581f595b53c5cb19bd0b3f8da6c935e2ca0000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000039b7e48529aa0c2900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000775f661b0bd1739349b9a2a3ef60be277c5d2d29000000000000000000000000775f661b0bd1739349b9a2a3ef60be277c5d2d2900000000000000000000000000000000000000000000000000000000000000010000000000000000000000009ed5175aecb6653c1bdaa19793c16fd74fbeeb37000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000003c6c6bd3a650000000000000000399fd604e44b870d000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed8000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f9460000000000000000000000000000000000000000000000004563918244f4000000000000000000000000000000000000000000000000000036be3e84a5ae26b20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000004563918244f4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002827b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a2231323939342e383032303833363638222c22416d6f756e744f7574555344223a223236373838382e35363131353835333636222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2234313532323732363937393537323534393235222c2254696d657374616d70223a313734373233313832302c22526f7574654944223a2265383038393439382d303833332d346131302d613661632d3936613663636439306566623a35383135623961372d353465382d343033652d386334622d343931383666343431656133222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22532f6b2f6c65505674667346597551634a36457032634f6943434a4950496c532f3634434879447854756e773250656f6164304e564952797261644430642f52636975417448447748665a6e626d782f507945785948332f35414f372f776934694d346855527a63573231326f5a6756454c71432b764643697835527236504b706e426f50386658364f72394a35506844746e55412f566c76503455556945516869656f7a4e33526f6c73353630536f4b684f43724558674a4866517972414871434a674c567262633050436d746c716a37707930555a38676b7364684c6f67545364476b6d4b5777724977773356445074565965693139706c69644c6972416a33513245656d656d6b48657648616e4e3139774a55474759513151454f71534f6668776b5448445961666f55647a744641553251424a4c5831765348544c2b566e756a51744c674431417643444e7a684e587a4e413d3d227d7d000000000000000000000000000000000000000000000000000000000000",
            needScale: false
        });

        TokenInput memory tokenInput = TokenInput({
            tokenIn: wethToken,
            netTokenIn: amountIn,
            tokenMintSy: 0xD11c452fc99cF405034ee446803b6F6c1F6d5ED8,
            pendleSwap: 0xd4e9B0d466789d7F6201442eecCBA6a75A552db0,
            swapData: swapData
        });

        _swapTokenToPt(PENDLE_MARKET, _createDefaultApproxParams(), tokenInput, PT_TOKEN);
    }

    function test_swap_Pt_to_WETH() public {
        address wethToken = 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
        uint256 amountIn = 5e18; // 5.0 Pt
        uint256 minTokenOut = 497e16; // 4.97 WETH
        /*
        curl -X 'GET' \
    'https://api-v2.pendle.finance/core/v1/sdk/1/markets/0xBDb8F9729d3194f75fD1A3D9bc4FFe0DDe3A404c/swap?receiver=0xBDb8F9729d3194f75fD1A3D9bc4FFe0DDe3A404c&slippage=0.05&enableAggregator=true&tokenIn=0x84D17Ef6BeC165484c320B852eEB294203e191be&tokenOut=0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2&amountIn=5000000000000000000' \
    -H 'accept: application/json'
        */

        SwapData memory swapData = SwapData({
            swapType: SwapType(1),
            extRouter: 0x6131B5fae19EA4f9D964eAc0408E4408b66337b5,
            extCalldata: hex"e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000007600000000000000000000000000000000000000000000000000000000000000460000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed8000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000007fffffff0000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000040d90ce491000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000100000000000000000000000000394a1e1b934cb4f4a0dc17bdd592ec078741542f000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed8000000000000000000000000cd5fe23c85820f7b72d0926fc9b05b43e359b7ee000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000003a8ce7fbf8349e0100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000202a6012894ae5c288ea824cbc8a9bfb26a49b93000000000000000000000000cd5fe23c85820f7b72d0926fc9b05b43e359b7ee000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000420a598cfaaffdf1000000000000000000000000fffd8963efd1fc6a506488495d951d5263988d250000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000049e6e04f7320000000000000000467a724344f0c34f000000000000000000000000d11c452fc99cf405034ee446803b6f6c1f6d5ed8000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f9460000000000000000000000000000000000000000000000003a8ce7fbf8349e0100000000000000000000000000000000000000000000000042f452f31b17ecbe0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000003a8ce7fbf8349e0100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002867b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a22333234372e34383030363331373839373033222c22416d6f756e744f7574555344223a2231333036342e373535363238333531323939222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2235303738343937313633303538363630313735222c2254696d657374616d70223a313734373233333631312c22526f7574654944223a2265313163343566632d393435382d346566342d383932642d3531333632366530346363303a66366433383230612d346261632d343438302d393735662d303662613733653739346436222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2252766a346e58755a5150507578796373455138726f58486d5866665a6450306f6f4b3048436b746d46754d497033332f6b566e704b6f4e5476306852644962796744786d69644a76395277486f6577337966504e56364f726736566a6a6f49656442636e6d3559676d5a342b4558455178724748724e355647756851613170437072494570383541397570704b6c35504d2b356f38505a415670302f3047363167547762692f4170594f64613934494c4e3444324457454f71766d5a696951794f4e346d666247736f544d4c766b78586c48454b7a724f715455467358413571636e7a332f2f4236706a466e5164455776744f736f6a485a6b4e665650336f7330786e4f6c32564c597041316a6b62504a4d4e7a56634e30535446332f534e4b39696970777076487864794f306a565831486e37725a5832354c34727769764b395172534f4937703158457a65624854434f4e5454773d3d227d7d0000000000000000000000000000000000000000000000000000",
            needScale: true
        });

        TokenOutput memory tokenOutput = TokenOutput({
            tokenOut: wethToken,
            minTokenOut: minTokenOut,
            tokenRedeemSy: 0xD11c452fc99cF405034ee446803b6F6c1F6d5ED8,
            pendleSwap: 0xd4e9B0d466789d7F6201442eecCBA6a75A552db0,
            swapData: swapData
        });

        _swapPtToToken(PENDLE_MARKET, PT_TOKEN, amountIn, tokenOutput);
    }

    function test_swap_pt_to_wstETH() public {
        address wstETHToken = 0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0;
        uint256 amountIn = 1e18;

        TokenOutput memory tokenOutput = _createTokenOutputSimple(wstETHToken, 0);

        _swapPtToToken(PENDLE_MARKET, PT_TOKEN, amountIn, tokenOutput);
    }

    function test_swap_pt_to_stETHToken() public {
        address stETHToken = 0xae7ab96520DE3A18E5e111B5EaAb095312D7fE84;
        uint256 amountIn = 1e18;

        TokenOutput memory tokenOutput = _createTokenOutputSimple(stETHToken, 0);

        _swapPtToToken(PENDLE_MARKET, PT_TOKEN, amountIn, tokenOutput);
    }

    function test_swap_pt_to_tETHToken() public {
        address tETHToken = 0xD11c452fc99cF405034ee446803b6F6c1F6d5ED8;
        uint256 amountIn = 1e18;

        TokenOutput memory tokenOutput = _createTokenOutputSimple(tETHToken, 0);

        _swapPtToToken(PENDLE_MARKET, PT_TOKEN, amountIn, tokenOutput);
    }

    function test_add_liquidity_wstETH() public {
        address wstETHToken = 0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0;
        uint256 amountIn = 1e18;

        _addLiquidity(PENDLE_MARKET, _createDefaultApproxParams(), _createTokenInputSimple(wstETHToken, amountIn));
    }

    function test_remove_liquidity_wstETH() public {
        address wstETHToken = 0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0;
        uint256 lpAmount = 1e18;

        _removeLiquidity(PENDLE_MARKET, lpAmount, _createTokenOutputSimple(wstETHToken, 0));
    }
}
